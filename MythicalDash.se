#!/bin/bash
set -e

###################################################
# ðŸš€ MythicalDash Professional Installer
# ðŸ‘‘ Powered By Para | Hardened & Production Ready
###################################################

clear
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”¥ MythicalDash Professional Installer"
echo "âœ¨ Powered By shadow"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

#############################
# ðŸ”’ ROOT CHECK
#############################
if [ "$EUID" -ne 0 ]; then
  echo "âŒ Please run as root"
  exit 1
fi

#############################
# ðŸŒ DOMAIN INPUT
#############################
read -p "ðŸŒ Enter your domain (panel.example.com): " DOMAIN
if [[ -z "$DOMAIN" ]]; then
  echo "âŒ Domain cannot be empty"
  exit 1
fi

echo "âœ… Domain set to: $DOMAIN"
sleep 1

#############################
# ðŸ§ª OS DETECTION
#############################
. /etc/os-release
if [[ "$ID" != "ubuntu" && "$ID" != "debian" ]]; then
  echo "âŒ Only Ubuntu / Debian supported"
  exit 1
fi

#############################
# ðŸ“¦ SYSTEM UPDATE
#############################
echo "ðŸ“¦ Updating system..."
apt update -y && apt upgrade -y

#############################
# ðŸ“¦ DEPENDENCIES
#############################
echo "ðŸ“¦ Installing dependencies..."
apt install -y software-properties-common curl ca-certificates gnupg lsb-release unzip git redis-server cron make dos2unix screen openssl nginx mariadb-server

#############################
# ðŸ˜ PHP 8.3
#############################
if [[ "$ID" == "ubuntu" ]]; then
  add-apt-repository -y ppa:ondrej/php
else
  curl -fsSL https://packages.sury.org/php/apt.gpg | gpg --dearmor -o /usr/share/keyrings/php.gpg
  echo "deb [signed-by=/usr/share/keyrings/php.gpg] https://packages.sury.org/php/ $VERSION_CODENAME main" \
  > /etc/apt/sources.list.d/php.list
fi

apt update -y
apt install -y php8.3 php8.3-{cli,fpm,common,gd,mysql,mbstring,bcmath,xml,curl,zip,redis}

systemctl enable --now cron redis-server mariadb php8.3-fpm

#############################
# ðŸŽ¼ COMPOSER
#############################
if ! command -v composer &>/dev/null; then
  echo "ðŸŽ¼ Installing Composer..."
  curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
fi

#############################
# ðŸ“¥ PANEL FILES
#############################
echo "ðŸ“¥ Installing MythicalDash..."
INSTALL_DIR="/var/www/mythicaldash-v3"
rm -rf $INSTALL_DIR
mkdir -p $INSTALL_DIR
cd $INSTALL_DIR

curl -Lo MythicalDash.zip https://github.com/MythicalLTD/MythicalDash/releases/latest/download/MythicalDash.zip
unzip MythicalDash.zip
rm MythicalDash.zip

chown -R www-data:www-data $INSTALL_DIR

#############################
# ðŸ“¦ BACKEND DEPENDENCIES
#############################
cd backend
COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader

#############################
# ðŸ—„ DATABASE SETUP (FIXED)
#############################
DB="mythicaldash_remastered"
DB_USER="mythicaldash_remastered"
DB_PASS=$(openssl rand -base64 16)

echo "ðŸ—„ Setting up database..."

mysql <<EOF
DROP DATABASE IF EXISTS $DB;
DROP USER IF EXISTS '$DB_USER'@'localhost';
DROP USER IF EXISTS '$DB_USER'@'127.0.0.1';

CREATE DATABASE $DB CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER '$DB_USER'@'localhost' IDENTIFIED BY '$DB_PASS';
CREATE USER '$DB_USER'@'127.0.0.1' IDENTIFIED BY '$DB_PASS';

GRANT ALL PRIVILEGES ON $DB.* TO '$DB_USER'@'localhost';
GRANT ALL PRIVILEGES ON $DB.* TO '$DB_USER'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF

echo "âœ… Database created"
echo "ðŸ”‘ DB Password: $DB_PASS"

#############################
# âš™ PRODUCTION BUILD
#############################
cd $INSTALL_DIR
make set-prod

#############################
# â± CRON JOBS
#############################
(crontab -l 2>/dev/null | grep -v mythicaldash; echo "* * * * * bash $INSTALL_DIR/backend/storage/cron/runner.bash >/dev/null 2>&1") | crontab -

#############################
# ðŸ” SSL (SELF-SIGNED)
#############################
SSL_DIR="/etc/certs/MythicalDash"
mkdir -p $SSL_DIR
openssl req -x509 -nodes -days 3650 -newkey rsa:4096 \
  -subj "/CN=$DOMAIN" \
  -keyout $SSL_DIR/privkey.pem \
  -out $SSL_DIR/fullchain.pem

#############################
# ðŸŒ NGINX CONFIG
#############################
NGINX_CONF="/etc/nginx/sites-available/mythicaldash.conf"

cat > $NGINX_CONF <<EOF
server {
  listen 80;
  server_name $DOMAIN;
  return 301 https://\$host\$request_uri;
}

server {
  listen 443 ssl http2;
  server_name $DOMAIN;

  root $INSTALL_DIR/frontend/dist;
  index index.html;

  ssl_certificate $SSL_DIR/fullchain.pem;
  ssl_certificate_key $SSL_DIR/privkey.pem;

  location / {
    try_files \$uri \$uri/ /index.html;
  }

  location /api {
    proxy_pass http://127.0.0.1:6000;
    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
  }

  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_pass unix:/run/php/php8.3-fpm.sock;
    fastcgi_param SCRIPT_FILENAME $INSTALL_DIR/backend/public\$fastcgi_script_name;
  }
}
EOF

ln -sf $NGINX_CONF /etc/nginx/sites-enabled/mythicaldash.conf
rm -f /etc/nginx/sites-enabled/default

nginx -t
systemctl reload nginx

#############################
# ðŸ‘¤ ADMIN USER
#############################
cd $INSTALL_DIR
php mythicaldash makeAdmin

#############################
# ðŸŽ‰ FINISH
#############################
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸŽ‰ MythicalDash Installed Successfully!"
echo "ðŸ”— URL: https://$DOMAIN"
echo "ðŸ—„ Database: $DB"
echo "ðŸ‘¤ DB User: $DB_USER"
echo "ðŸ”‘ DB Pass: $DB_PASS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
