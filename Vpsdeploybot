#!/bin/bash
set -e

# ===== ðŸŽ¨ COLORS =====
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# ===== ðŸ§  Typewriter Effect =====
typewriter() {
  text="$1"
  delay="${2:-0.03}"
  for ((i = 0; i < ${#text}; i++)); do
    echo -n "${text:$i:1}"
    sleep "$delay"
  done
  echo ""
}

clear
echo -e "${CYAN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     ðŸš€ VPS Deploy Bot Installer by shadow     â•‘"
echo "â•‘           âš™ï¸  Powered by SpireCloud          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
sleep 1

# ===== ðŸŒ€ Spinner =====
spinner() {
    local pid=$1
    local delay=0.1
    local spinstr='|/-\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

run_cmd() {
    echo -ne "${YELLOW}[~] $1...${NC}"
    bash -c "$2" >/dev/null 2>&1 &
    spinner $!
    echo -e "${GREEN} [OK]${NC}"
}

# ===== âš™ï¸ Installation =====
typewriter "ðŸ”„ Updating system packages..."
run_cmd "Updating system" "apt update -y && apt upgrade -y"

typewriter "ðŸ“¦ Installing dependencies..."
run_cmd "Installing core tools" "apt install -y curl neofetch openssh-server git nano docker.io python3-pip python3-full"

run_cmd "Restarting Docker" "systemctl restart docker"
run_cmd "Enabling Docker" "systemctl enable docker"

if [ ! -d "/opt/vps-deploy-bot" ]; then
    run_cmd "ðŸ“¥ Cloning repository" "git clone https://github.com/hycroedev/vps-deploy-bot.git /opt/vps-deploy-bot"
else
    run_cmd "ðŸ” Updating repository" "cd /opt/vps-deploy-bot && git pull"
fi

cd /opt/vps-deploy-bot

typewriter "ðŸ Installing Python dependencies..."
run_cmd "Installing Python modules" "pip install --upgrade pip && pip install discord.py docker psutil aiohttp requests"

run_cmd "ðŸ§ Building Debian Docker image" "docker build -t debian-vps -f Dockerfile.debian ."
run_cmd "ðŸŸ  Building Ubuntu Docker image" "docker build -t ubuntu-vps -f Dockerfile.ubuntu ."

# ===== âš™ï¸ User Configuration =====
echo -e "${CYAN}\nðŸ’¬ Enter your Discord Bot Token:${NC}"
read BOT_TOKEN

echo -e "${CYAN}ðŸ’¬ Enter Logs Channel ID:${NC}"
read LOGS_CHANNEL

echo -e "${CYAN}ðŸ’¬ Enter Admin Role ID:${NC}"
read ADMIN_ROLE

run_cmd "ðŸ§© Configuring bot.py" \
"sed -i \"s|^TOKEN = .*|TOKEN = '${BOT_TOKEN}'  # BOT TOKEN|\" bot.py && \
 sed -i \"s|^RAM_LIMIT = .*|RAM_LIMIT = '2g'|\" bot.py && \
 sed -i \"s|^SERVER_LIMIT = .*|SERVER_LIMIT = 12|\" bot.py && \
 sed -i \"s|^LOGS_CHANNEL_ID = .*|LOGS_CHANNEL_ID = ${LOGS_CHANNEL}    # LOGS CHANNEL|\" bot.py && \
 sed -i \"s|^ADMIN_ROLE_ID = .*|ADMIN_ROLE_ID = ${ADMIN_ROLE}     # ADMIN ROLE|\" bot.py"

# ===== ðŸ”§ Service Setup =====
echo -e "${CYAN}\nâš™ï¸ Do you want to run the bot as a service (y/n)?${NC}"
read RUN_SERVICE

if [[ "$RUN_SERVICE" == "y" ]]; then
    cat > /etc/systemd/system/vps-bot.service <<SERVICE
[Unit]
Description=VPS Deploy Discord Bot
After=network.target

[Service]
WorkingDirectory=/opt/vps-deploy-bot
ExecStart=/usr/bin/python3 /opt/vps-deploy-bot/bot.py
Restart=always
Environment=PYTHONUNBUFFERED=1

[Install]
WantedBy=multi-user.target
SERVICE

    run_cmd "âš¡ Enabling bot service" "systemctl daemon-reload && systemctl enable vps-bot && systemctl start vps-bot"
    echo -e "${GREEN}[âœ“] Bot service created and started successfully!${NC}"
    echo -e "${YELLOW}ðŸ§  Check logs with: ${CYAN}systemctl status vps-bot${NC}"
else
    echo -e "${YELLOW}ðŸ’¡ To run manually: ${CYAN}cd /opt/vps-deploy-bot && python3 bot.py${NC}"
fi

# ===== ðŸŽ‰ Done =====
echo -e "${GREEN}"
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘ âœ… Installation Complete!                   â•‘"
echo "â•‘ ðŸ’« Script crafted with â¤ï¸  by shadow          â•‘"
echo "â•‘ ðŸŒ Powered by Spirecloud                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo -e "${NC}"
